!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery-ui/sortable"],a):a(window.jQuery)}(function(a){"use strict";function b(a,b,c){return a>b&&a<b+c}a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{disableParentChange:!1,doNotClear:!1,expandOnHover:700,isAllowed:function(){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var c,b=this;if(this.element.data("ui-sortable",this.element.data("mjs-nestedSortable")),!this.element.is(this.options.listType))throw c="nestedSortable: Please check that the listType option is set to your actual list type",new Error(c);this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),a.ui.sortable.prototype._create.apply(this,arguments),this.options.isTree&&a(this.items).each(function(){var a=this.item,c=a.hasClass(b.options.collapsedClass),d=a.hasClass(b.options.expandedClass);a.children(b.options.listType).length?(a.addClass(b.options.branchClass),c||d||(b.options.startCollapsed?a.addClass(b.options.collapsedClass):a.addClass(b.options.expandedClass))):a.addClass(b.options.leafClass)})},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),a.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(b){var c,d,e,f,k,l,m,n,o,p,q,r,s,t,u,v,g=this,h=this.options,i=!1,j=a(document);for(this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==document&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<h.scrollSensitivity?(i=this.scrollParent.scrollTop()+h.scrollSpeed,this.scrollParent.scrollTop(i)):b.pageY-this.overflowOffset.top<h.scrollSensitivity&&(i=this.scrollParent.scrollTop()-h.scrollSpeed,this.scrollParent.scrollTop(i)),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<h.scrollSensitivity?(i=this.scrollParent.scrollLeft()+h.scrollSpeed,this.scrollParent.scrollLeft(i)):b.pageX-this.overflowOffset.left<h.scrollSensitivity&&(i=this.scrollParent.scrollLeft()-h.scrollSpeed,this.scrollParent.scrollLeft(i))):(b.pageY-j.scrollTop()<h.scrollSensitivity?(i=j.scrollTop()-h.scrollSpeed,j.scrollTop(i)):a(window).height()-(b.pageY-j.scrollTop())<h.scrollSensitivity&&(i=j.scrollTop()+h.scrollSpeed,j.scrollTop(i)),b.pageX-j.scrollLeft()<h.scrollSensitivity?(i=j.scrollLeft()-h.scrollSpeed,j.scrollLeft(i)):a(window).width()-(b.pageX-j.scrollLeft())<h.scrollSensitivity&&(i=j.scrollLeft()+h.scrollSpeed,j.scrollLeft(i))),i!==!1&&a.ui.ddmanager&&!h.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b)),this.positionAbs=this._convertPositionTo("absolute"),k=this.placeholder.offset().top,this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),this.hovering=this.hovering?this.hovering:null,this.mouseentered=!!this.mouseentered&&this.mouseentered,function(){var a=this.placeholder.parent().parent();a&&a.closest(".ui-sortable").length&&(l=a)}.call(this),m=this._getLevel(this.placeholder),n=this._getChildLevels(this.helper),q=document.createElement(h.listType),c=this.items.length-1;c>=0;c--)if(d=this.items[c],e=d.item[0],f=this._intersectsWithPointer(d),f&&d.instance===this.currentContainer){if(e.className.indexOf(h.disabledClass)!==-1)if(2===f){if(o=this.items[c+1],o&&o.item.hasClass(h.disabledClass))continue}else if(1===f&&(p=this.items[c-1],p&&p.item.hasClass(h.disabledClass)))continue;if(r=1===f?"next":"prev",!(e===this.currentItem[0]||this.placeholder[r]()[0]===e||a.contains(this.placeholder[0],e)||"semi-dynamic"===this.options.type&&a.contains(this.element[0],e))){if(this.mouseentered||(a(e).mouseenter(),this.mouseentered=!0),h.isTree&&a(e).hasClass(h.collapsedClass)&&h.expandOnHover&&(this.hovering||(a(e).addClass(h.hoveringClass),this.hovering=window.setTimeout(function(){a(e).removeClass(h.collapsedClass).addClass(h.expandedClass),g.refreshPositions(),g._trigger("expand",b,g._uiHash())},h.expandOnHover))),this.direction=1===f?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(d))break;a(e).mouseleave(),this.mouseentered=!1,a(e).removeClass(h.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,!h.protectRoot||this.currentItem[0].parentNode===this.element[0]&&e.parentNode!==this.element[0]?h.protectRoot||this._rearrange(b,d):this.currentItem[0].parentNode!==this.element[0]&&e.parentNode===this.element[0]?(a(e).children(h.listType).length||(e.appendChild(q),h.isTree&&a(e).removeClass(h.leafClass).addClass(h.branchClass+" "+h.expandedClass)),s="down"===this.direction?a(e).prev().children(h.listType):a(e).children(h.listType),void 0!==s[0]&&this._rearrange(b,null,s)):this._rearrange(b,d),this._clearEmpty(e),this._trigger("change",b,this._uiHash());break}}if(function(){var a=this.placeholder.prev();t=a.length?a:null}.call(this),null!=t)for(;"li"!==t[0].nodeName.toLowerCase()||t[0].className.indexOf(h.disabledClass)!==-1||t[0]===this.currentItem[0]||t[0]===this.helper[0];){if(!t[0].previousSibling){t=null;break}t=a(t[0].previousSibling)}if(function(){var a=this.placeholder.next();u=a.length?a:null}.call(this),null!=u)for(;"li"!==u[0].nodeName.toLowerCase()||u[0].className.indexOf(h.disabledClass)!==-1||u[0]===this.currentItem[0]||u[0]===this.helper[0];){if(!u[0].nextSibling){u=null;break}u=a(u[0].nextSibling)}return this.beyondMaxLevels=0,null==l||null!=u||h.protectRoot&&l[0].parentNode==this.element[0]||!(h.rtl&&this.positionAbs.left+this.helper.outerWidth()>l.offset().left+l.outerWidth()||!h.rtl&&this.positionAbs.left<l.offset().left)?null==t||t.hasClass(h.disableNestingClass)||!(t.children(h.listType).length&&t.children(h.listType).is(":visible")||!t.children(h.listType).length)||h.protectRoot&&this.currentItem[0].parentNode===this.element[0]||!(h.rtl&&this.positionAbs.left+this.helper.outerWidth()<t.offset().left+t.outerWidth()-h.tabSize||!h.rtl&&this.positionAbs.left>t.offset().left+h.tabSize)?this._isAllowed(l,m,m+n):(this._isAllowed(t,m,m+n+1),t.children(h.listType).length||(t[0].appendChild(q),h.isTree&&t.removeClass(h.leafClass).addClass(h.branchClass+" "+h.expandedClass)),k&&k<=t.offset().top?t.children(h.listType).prepend(this.placeholder):t.children(h.listType)[0].appendChild(this.placeholder[0]),"undefined"!=typeof l&&this._clearEmpty(l[0]),this._trigger("change",b,this._uiHash())):(l.after(this.placeholder[0]),v=!l.children(h.listItem).children("li:visible:not(.ui-sortable-helper)").length,h.isTree&&v&&l.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),"undefined"!=typeof l&&this._clearEmpty(l[0]),this._trigger("change",b,this._uiHash())),this._contactContainers(b),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?a(this.domPosition.prev).after(this.placeholder):a(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",b,this._uiHash())),a("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,this._relocate_event=b,this._pid_current=a(this.domPosition.parent).parent().attr("id"),this._sort_current=this.domPosition.prev?a(this.domPosition.prev).next().index():0,a.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(a){var c=this.options.isTree?.8:.5,d=b(this.positionAbs.top+this.offset.click.top,a.top+a.height*c,a.height),e=b(this.positionAbs.top+this.offset.click.top,a.top-a.height*c,a.height),f=b(this.positionAbs.left+this.offset.click.left,a.left+a.width/2,a.width),g=this._getDragVerticalDirection(),h=this._getDragHorizontalDirection();return this.floating&&h?"right"===h&&f||"left"===h&&!f:g&&("down"===g&&d||"up"===g&&e)},_contactContainers:function(){this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]||a.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var b,c;for(a.ui.sortable.prototype._clear.apply(this,arguments),this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index()||this._trigger("relocate",this._relocate_event,this._uiHash()),b=this.items.length-1;b>=0;b--)c=this.items[b].item[0],this._clearEmpty(c)},serialize:function(b){var c=a.extend({},this.options,b),d=this._getItemsAsjQuery(c&&c.connected),e=[];return a(d).each(function(){var b=(a(c.item||this).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/),d=(a(c.item||this).parent(c.listType).parent(c.items).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/);b&&e.push((c.key||b[1])+"["+(c.key&&c.expression?b[1]:b[2])+"]="+(d?c.key&&c.expression?d[1]:d[2]:c.rootID))}),!e.length&&c.key&&e.push(c.key+"="),e.join("&")},toHierarchy:function(b){function e(b){var f,d=(a(b).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/),g=a(b).data();if(g.nestedSortableItem&&delete g.nestedSortableItem,d)return f={id:d[2]},f=a.extend({},f,g),a(b).children(c.listType).children(c.items).length>0&&(f.children=[],a(b).children(c.listType).children(c.items).each(function(){var a=e(this);f.children.push(a)})),f}var c=a.extend({},this.options,b),d=[];return a(this.element).children(c.items).each(function(){var a=e(this);d.push(a)}),d},toArray:function(b){function g(b,f,h){var j,k,l,i=h+1;if(a(b).children(c.listType).children(c.items).length>0&&(f++,a(b).children(c.listType).children(c.items).each(function(){i=g(a(this),f,i)}),f--),j=(a(b).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/),f===d?k=c.rootID:(l=a(b).parent(c.listType).parent(c.items).attr(c.attribute||"id").match(c.expression||/(.+)[-=_](.+)/),k=l[2]),j){var m=a(b).children("div").data(),n=a.extend(m,{id:j[2],parent_id:k,depth:f,left:h,right:i});e.push(n)}return h=i+1}var c=a.extend({},this.options,b),d=c.startDepthCount||0,e=[],f=1;return c.excludeRoot||(e.push({item_id:c.rootID,parent_id:null,depth:d,left:f,right:2*(a(c.items,this.element).length+1)}),f++),a(this.element).children(c.items).each(function(){f=g(this,d,f)}),e=e.sort(function(a,b){return a.left-b.left})},_clearEmpty:function(b){function c(b,c,d,e){e&&(c=[d,d=c][0]),a(b).removeClass(c).addClass(d)}var d=this.options,e=a(b).children(d.listType),f=e.has("li").length,g=d.doNotClear||f||d.protectRoot&&a(b)[0]===this.element[0];d.isTree&&c(b,d.branchClass,d.leafClass,g),g||(e.parent().removeClass(d.expandedClass),e.remove())},_getLevel:function(a){var c,b=1;if(this.options.listType)for(c=a.closest(this.options.listType);c&&c.length>0&&!c.is(".ui-sortable");)b++,c=c.parent().closest(this.options.listType);return b},_getChildLevels:function(b,c){var d=this,e=this.options,f=0;return c=c||0,a(b).children(e.listType).children(e.items).each(function(a,b){f=Math.max(d._getChildLevels(b,c+1),f)}),c?f+1:f},_isAllowed:function(a,b,c){var d=this.options,e=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),f=this.currentItem.parent().parent(),g=d.disableParentChange&&("undefined"!=typeof a&&!f.is(a)||"undefined"==typeof a&&f.is("li"));g||!d.isAllowed(this.placeholder,a,this.currentItem)?(this.placeholder.addClass(d.errorClass),e<c&&0!==e?this.beyondMaxLevels=c-e:this.beyondMaxLevels=1):e<c&&0!==e?(this.placeholder.addClass(d.errorClass),this.beyondMaxLevels=c-e):(this.placeholder.removeClass(d.errorClass),this.beyondMaxLevels=0)}})),a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)});
